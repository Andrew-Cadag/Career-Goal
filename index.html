<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Security Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <style>
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* Light Mode Theme */
        :root {
            --bg-color: #f3f4f6; /* gray-100 */
            --text-color: #1f2937; /* gray-800 */
            --card-bg: rgba(255, 255, 255, 0.7);
            --border-color: rgba(209, 213, 219, 0.5); /* gray-300 */
            --header-text: #111827; /* gray-900 */
            --subheader-text: #4b5563; /* gray-600 */
            --rank-text: #ca8a04; /* yellow-600 */
            --xp-text: #52525b; /* zinc-600 */
            --spotlight-color: rgba(20, 83, 45, 0.3);
        }

        /* Dark Mode Theme */
        html.dark {
            --bg-color: #111827; /* gray-900 */
            --text-color: #d1d5db; /* gray-300 */
            --card-bg: rgba(17, 24, 39, 0.5); /* gray-900 with opacity */
            --border-color: rgba(55, 65, 81, 0.5); /* gray-700 */
            --header-text: #ffffff;
            --subheader-text: #9ca3af; /* gray-400 */
            --rank-text: #facc15; /* yellow-400 */
            --xp-text: #a1a1aa; /* zinc-400 */
            --spotlight-color: rgba(20, 209, 169, 0.15);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease;
        }

        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: linear-gradient(-45deg, #111827, #1f2937, #102d45, #111827); 
            background-size: 400% 400%; 
            animation: gradient 15s ease infinite;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        html.dark .animated-bg {
            opacity: 1;
        }

        .spotlight {
            position: fixed;
            top: 0;
            left: 0;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--spotlight-color), transparent 60%);
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: -1;
            transition: background 0.5s ease;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        .progress-item.completed { border-color: rgba(20, 209, 169, 0.5); }
        .progress-item.completed .card { background-color: rgba(17, 94, 89, 0.2); }
        html:not(.dark) .progress-item.completed .card { background-color: rgba(20, 209, 169, 0.1); }

        .progress-item.completed .check-icon { opacity: 1; }
        #radialProgressBar { transition: stroke-dashoffset 1s ease-out; }
        .stage-card, .platform-btn, .advanced-cert-toggle { transition: all 0.2s ease-in-out; }
        .check-icon { transition: opacity 0.3s ease-in-out; }
        .glow { box-shadow: 0 0 15px rgba(20, 209, 169, 0.3), 0 0 5px rgba(20, 209, 169, 0.2); }

        .advanced-cert-toggle.completed {
            color: #10b981; /* teal-500 */
        }
        html.dark .advanced-cert-toggle.completed {
            color: #2dd4bf; /* teal-400 */
        }
    </style>
</head>
<body class="text-gray-300">
    <div class="spotlight"></div>
    <div class="animated-bg"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-6xl relative">
        <header class="text-center mb-12 relative">
            <h1 class="text-4xl md:text-5xl font-extrabold" style="color: var(--header-text);">Cloud Security Command Center</h1>
            <p class="mt-3 text-lg" style="color: var(--subheader-text);">Your personalized dashboard for mastering cloud security.</p>
            
            <!-- Theme Toggle -->
            <div class="absolute top-0 right-0">
                <label for="theme-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="theme-toggle" class="sr-only">
                        <div class="block bg-gray-600 dark:bg-gray-700 w-14 h-8 rounded-full"></div>
                        <div id="theme-dot" class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition transform flex items-center justify-center">
                            <i data-feather="sun" class="text-yellow-500"></i>
                        </div>
                    </div>
                </label>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Profile & Stash -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Profile Card -->
                <div class="card rounded-2xl p-6 text-center relative">
                    <button id="editProfileBtn" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                    <div class="relative w-32 h-32 mx-auto">
                        <svg class="w-full h-full" viewBox="0 0 120 120">
                            <circle class="text-gray-400 dark:text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60"/>
                            <circle id="radialProgressBar" class="text-teal-500" stroke-width="8" stroke-dasharray="339.29" stroke-dashoffset="339.29" stroke-linecap="round" stroke="currentColor" fill="transparent" r="54" cx="60" cy="60" transform="rotate(-90 60 60)"/>
                        </svg>
                        <div id="profileAvatar" class="absolute inset-0 flex items-center justify-center">
                             <i data-feather="user" class="w-20 h-20 text-teal-500"></i>
                        </div>
                        <div id="radialProgressText" class="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-gray-200 dark:bg-gray-800 px-2 py-0.5 rounded-full text-xs font-bold" style="color: var(--text-color);">0%</div>
                    </div>
                    <h3 id="profileDisplayName" class="text-xl font-bold mt-4 truncate" style="color: var(--header-text);">Anonymous Quester</h3>
                    <p id="rankDisplay" class="font-bold text-lg transition-colors" style="color: var(--rank-text);">IT Novice</p>
                    <p id="xpCounter" class="text-sm" style="color: var(--xp-text);">0 XP</p>
                </div>
                
                <!-- Study Stash -->
                <div class="card rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-semibold" style="color: var(--header-text);">My Study Stash</h2>
                        <button id="uploadStudyMaterialBtn" class="flex items-center space-x-2 text-xs bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-bold py-2 px-3 rounded-md transition"><i data-feather="plus" class="w-4 h-4"></i><span>Add</span></button>
                        <input type="file" id="studyMaterialInput" class="hidden" multiple>
                    </div>
                    <ul id="studyStashList" class="space-y-2 max-h-60 overflow-y-auto"></ul>
                </div>
            </div>

            <!-- Right Column: Quest & Career -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Path Selector -->
                <div>
                     <h2 class="text-lg font-semibold mb-3" style="color: var(--header-text);">Your Cloud Path</h2>
                     <div class="card flex justify-center space-x-2 p-2 rounded-xl">
                        <button data-platform="aws" class="platform-btn flex-1 text-sm font-bold py-2 px-4 rounded-lg"><i class="inline-block mr-2" data-feather="box"></i>AWS</button>
                        <button data-platform="azure" class="platform-btn flex-1 text-sm font-bold py-2 px-4 rounded-lg"><i class="inline-block mr-2" data-feather="layers"></i>Azure</button>
                        <button data-platform="gcp" class="platform-btn flex-1 text-sm font-bold py-2 px-4 rounded-lg"><i class="inline-block mr-2" data-feather="cloud"></i>GCP</button>
                    </div>
                </div>

                <!-- Quest Stages -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div id="stage1-card" data-stage="stage1" class="progress-item stage-card card p-6 rounded-2xl cursor-pointer"><div class="flex justify-between items-start"><div class="flex-shrink-0 w-10 h-10 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center"><i data-feather="database" class="w-5 h-5 text-teal-500"></i></div><i data-feather="check-circle" class="check-icon opacity-0 w-6 h-6 text-teal-500"></i></div><div class="mt-4"><p class="text-xs" style="color: var(--subheader-text);">Stage 1</p><h3 class="text-xl font-bold" style="color: var(--header-text);">The IT Bedrock</h3></div></div>
                    <div id="stage2-card" data-stage="stage2" class="progress-item stage-card card p-6 rounded-2xl cursor-pointer"><div class="flex justify-between items-start"><div class="flex-shrink-0 w-10 h-10 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center"><i data-feather="shield" class="w-5 h-5 text-teal-500"></i></div><i data-feather="check-circle" class="check-icon opacity-0 w-6 h-6 text-teal-500"></i></div><div class="mt-4"><p class="text-xs" style="color: var(--subheader-text);">Stage 2</p><h3 class="text-xl font-bold" style="color: var(--header-text);">Cybersecurity Principles</h3></div></div>
                    <div id="stage3-card" data-stage="stage3" class="progress-item stage-card card p-6 rounded-2xl cursor-pointer"><div class="flex justify-between items-start"><div class="stage-icon flex-shrink-0 w-10 h-10 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center"></div><i data-feather="check-circle" class="check-icon opacity-0 w-6 h-6 text-teal-500"></i></div><div class="mt-4"><p class="text-xs" style="color: var(--subheader-text);">Stage 3</p><h3 class="stage-title text-xl font-bold" style="color: var(--header-text);"></h3></div></div>
                    <div id="stage4-card" data-stage="stage4" class="progress-item stage-card card p-6 rounded-2xl cursor-pointer"><div class="flex justify-between items-start"><div class="stage-icon flex-shrink-0 w-10 h-10 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center"></div><i data-feather="check-circle" class="check-icon opacity-0 w-6 h-6 text-teal-500"></i></div><div class="mt-4"><p class="text-xs" style="color: var(--subheader-text);">Stage 4</p><h3 class="stage-title text-xl font-bold" style="color: var(--header-text);"></h3></div></div>
                </div>

                <!-- Legendary Ranks -->
                <div class="card rounded-2xl p-6">
                    <h2 class="font-semibold mb-4" style="color: var(--header-text);">Legendary Ranks</h2>
                    <ul class="space-y-3">
                        <li data-cert="ccsp" class="progress-item advanced-cert-toggle flex items-center justify-between p-3 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-800/50 text-gray-700 dark:text-gray-400"><span class="flex items-center space-x-3"><i data-feather="shield" class="w-5 h-5"></i><span>Certified Cloud Security Professional (CCSP)</span></span><i data-feather="check-circle" class="check-icon opacity-0 w-6 h-6"></i></li>
                        <li data-cert="cissp" class="progress-item advanced-cert-toggle flex items-center justify-between p-3 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-800/50 text-gray-700 dark:text-gray-400"><span class="flex items-center space-x-3"><i data-feather="award" class="w-5 h-5"></i><span>Certified Information Systems Security Professional (CISSP)</span></span><i data-feather="check-circle" class="check-icon opacity-0 w-6 h-6"></i></li>
                    </ul>
                </div>

                <!-- Career Command -->
                <div class="card rounded-2xl p-6">
                    <h2 class="font-semibold mb-4" style="color: var(--header-text);">Career Command: Unlocked Roles</h2>
                    <div id="jobListings" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stage Modal -->
    <div id="stageModal" class="hidden opacity-0 fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="absolute inset-0 bg-black/60 modal-bg"></div>
        <div class="card relative rounded-2xl w-full max-w-2xl m-4 flex flex-col" style="max-height: 90vh;">
             <div class="flex-shrink-0 p-6 border-b flex justify-between items-center" style="border-color: var(--border-color);"><h2 id="modalTitle" class="text-2xl font-bold" style="color: var(--header-text);"></h2><button id="closeModalButton" class="text-gray-500 hover:text-white"><i data-feather="x" class="w-6 h-6"></i></button></div>
            <div class="flex-shrink-0 px-6 border-b" style="border-color: var(--border-color);"><nav class="-mb-px flex space-x-6">
                <button id="tab_details" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Details</button>
                <button id="tab_uploads" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Uploads</button>
                <button id="tab_resources" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Resources</button>
            </nav></div>
            <div class="flex-grow p-6 overflow-y-auto space-y-6">
                <div id="content_details"><h3 class="font-semibold text-lg" style="color: var(--header-text);">Stage Overview</h3><p id="modalDetails" class="mt-2 text-sm"></p><h3 class="font-semibold text-lg mt-4" style="color: var(--header-text);">Key Project</h3><p id="modalProject" class="mt-2 text-sm"></p><h3 class="font-semibold text-lg mt-4" style="color: var(--header-text);">Relevance in the Philippines</h3><p id="modalPHContext" class="mt-2 text-sm"></p></div>
                <div id="content_uploads" class="hidden space-y-4">
                    <div class="bg-gray-200 dark:bg-gray-900/50 p-4 rounded-lg"><div class="flex justify-between items-center"><p class="font-semibold text-sm">Certificate:</p><button id="cert_upload_button" class="flex items-center space-x-2 text-xs bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 font-bold py-2 px-3 rounded-md transition"><i data-feather="upload-cloud" class="w-4 h-4"></i><span class="upload-text">Upload File</span></button></div><a id="cert_link" href="#" target="_blank" class="hidden mt-2 text-sm text-teal-500 hover:underline truncate block"></a><input type="file" id="cert_input" class="hidden"></div>
                    <div class="bg-gray-200 dark:bg-gray-900/50 p-4 rounded-lg"><div class="flex justify-between items-center"><p class="font-semibold text-sm">Project:</p><button id="proj_upload_button" class="flex items-center space-x-2 text-xs bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 font-bold py-2 px-3 rounded-md transition"><i data-feather="upload-cloud" class="w-4 h-4"></i><span class="upload-text">Upload File</span></button></div><a id="proj_link" href="#" target="_blank" class="hidden mt-2 text-sm text-teal-500 hover:underline truncate block"></a><input type="file" id="proj_input" class="hidden"></div>
                </div>
                <div id="content_resources" class="hidden"><ul id="modalResources" class="space-y-3"></ul></div>
            </div>
            <div class="flex-shrink-0 p-6 border-t bg-gray-200/50 dark:bg-gray-800/50 rounded-b-2xl" style="border-color: var(--border-color);"><button id="modalCompleteButton" class="w-full text-white font-bold py-3 px-4 rounded-lg transition">Mark as Complete</button></div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profileModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 modal-bg"></div>
        <div class="card relative rounded-2xl w-full max-w-md m-4 p-6">
            <button id="closeProfileModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-feather="x" class="w-6 h-6"></i></button>
            <h3 class="text-lg font-bold mb-4" style="color: var(--header-text);">Edit Your Profile</h3>
            <div>
                <label for="displayNameInput" class="block text-sm font-medium mb-1">Display Name</label>
                <input type="text" id="displayNameInput" class="w-full bg-gray-200 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-teal-500 focus:border-teal-500">
                <button id="saveDisplayNameBtn" class="w-full mt-2 bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-4 rounded-md transition">Save Name</button>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-300 dark:border-gray-700">
                <h4 class="text-sm font-medium mb-2">Choose Avatar</h4>
                <div id="avatarGrid" class="grid grid-cols-6 gap-2"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- App Configuration ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "your-fallback-api-key", authDomain: "your-fallback-auth-domain", projectId: "your-fallback-project-id" };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'cloud-security-tracker-v8-fixed';
            
            const STAGES_CONFIG = {
                stage1: { title: "The IT Bedrock", cert: "Google IT Support or equivalent", xp: 100, rank: "IT Novice", details: "Master the non-negotiable fundamentals of IT. This stage covers the core networking, operating systems, and administration concepts that all cloud infrastructure is built upon.", project: "Home Network Analysis: Document and diagram your home network. Identify all devices, their IP addresses, and research your router's security settings. This proves you can apply core networking concepts.", ph_context: "The BPO and services industry in the Philippines requires a strong foundation in IT support. This certificate is highly recognized as proof of these core skills.", resources: [ { name: "Google IT Support Certificate", url: "https://www.coursera.org/professional-certificates/google-it-support" } ] },
                stage2: { title: "Cybersecurity Principles", cert: "CompTIA Security+ or equivalent", xp: 150, rank: "Security Apprentice", details: "Grasp the core of cybersecurity. This involves understanding the CIA triad (Confidentiality, Integrity, Availability), threat modeling, risk assessment, and common attack vectors like the OWASP Top 10.", project: "Threat Model a Simple App: Choose a simple web application (like a blog) and create a basic threat model for it. Identify potential threats, vulnerabilities, and recommend countermeasures.", ph_context: "The Data Privacy Act of 2012 mandates security. This knowledge is the baseline requirement for any security role in the Philippines, especially in the banking and fintech sectors.", resources: [ { name: "Google Cybersecurity Certificate", url: "https://www.coursera.org/professional-certificates/google-cybersecurity" }, { name: "(ISC)² CC Certificate", url: "https://www.coursera.org/specializations/isc2-certified-in-cybersecurity" } ] }
            };
            const PLATFORM_PATHS = {
                gcp: { stage3: { title: "GCP Associate Engineer", cert: "Google Associate Cloud Engineer", xp: 200, rank: "GCP Associate", details: "Demonstrate your ability to deploy applications, monitor operations, and manage enterprise solutions on Google Cloud.", project: "Deploy a containerized web application on Google Kubernetes Engine (GKE) behind a load balancer.", ph_context: "GCP is rapidly growing in PH, especially in startups and data-driven companies. This cert is your entry ticket.", resources: [{name: "Google Cloud Engineer Path", url: "https://www.coursera.org/professional-certificates/google-cloud-engineer"}]}, stage4: { title: "GCP Security Specialist", cert: "Google Professional Cloud Security Engineer", xp: 300, rank: "GCP Guardian", details: "Secure Google Cloud environments by configuring identity and access, setting organizational policies, and configuring network security.", project: "Harden a default GCP deployment using CIS Benchmarks. Implement VPC Service Controls and analyze logs for threats.", ph_context: "The highest demand for GCP in PH is in security. This makes you a top-tier, high-salary candidate.", resources: [{name: "Google Cloud Security Path", url: "https://www.coursera.org/professional-certificates/google-cloud-security-engineer"}]} },
                aws: { stage3: { title: "AWS Solutions Architect", cert: "AWS Certified Solutions Architect - Associate", xp: 200, rank: "AWS Architect", details: "Learn to design and deploy scalable, highly available, and fault-tolerant systems on AWS.", project: "Build a serverless API using API Gateway, Lambda, and DynamoDB. Ensure it follows security best practices.", ph_context: "AWS is the market leader in the Philippines. This certification is the most requested cloud credential by local employers.", resources: [{name: "AWS SAA-C03 Learning Path", url: "https://aws.amazon.com/certification/certified-solutions-architect-associate/"}]}, stage4: { title: "AWS Security Specialist", cert: "AWS Certified Security - Specialty", xp: 300, rank: "AWS Guardian", details: "Master data protection, infrastructure security, incident response, and identity management on the AWS platform.", project: "Configure AWS GuardDuty, Security Hub, and CloudTrail. Write a Lambda function to automatically remediate a security finding.", ph_context: "As the market leader, securing AWS environments is a critical and high-paying job for major PH enterprises.", resources: [{name: "AWS Security Specialty Path", url: "https://aws.amazon.com/certification/certified-security-specialty/"}]} },
                azure: { stage3: { title: "Azure Administrator", cert: "Microsoft Certified: Azure Administrator Associate (AZ-104)", xp: 200, rank: "Azure Admin", details: "Implement, manage, and monitor identity, governance, storage, compute, and virtual networks in a cloud environment.", project: "Deploy a web app to Azure App Service, integrate it with Azure AD for authentication, and configure a backup policy.", ph_context: "Azure is dominant in the enterprise sector in the Philippines. This cert is key for corporate IT roles.", resources: [{name: "AZ-104 Exam Prep", url: "https://learn.microsoft.com/en-us/credentials/certifications/exams/az-104/"}]}, stage4: { title: "Azure Security Specialist", cert: "Microsoft Certified: Azure Security Engineer Associate (AZ-500)", xp: 300, rank: "Azure Guardian", details: "Secure Azure identity and access, implement platform protection, and secure data and applications.", project: "Implement Azure Sentinel in a demo environment. Create analytics rules to detect suspicious sign-ins and configure a playbook for response.", ph_context: "Securing corporate data on Azure is a top priority for PH businesses, making this a highly valuable certification.", resources: [{name: "AZ-500 Exam Prep", url: "https://learn.microsoft.com/en-us/credentials/certifications/exams/az-500/"}]} }
            };
            const ADVANCED_CERTS = { ccsp: { title: "Certified Cloud Security Professional (CCSP)", xp: 400 }, cissp: { title: "Certified Information Systems Security Professional (CISSP)", xp: 500 } };
            const JOB_DATA = { "IT Novice": [{ title: "IT Support Staff", company: "Tech Solutions Inc.", location: "Manila, PH" }, { title: "Help Desk Technician", company: "Global BPO", location: "Cebu, PH" }], "Security Apprentice": [{ title: "Junior Security Analyst", company: "SecureNet PH", location: "Makati, PH" }, { title: "SOC Analyst Tier 1", company: "CyberGuardians", location: "Taguig, PH" }], "GCP Associate": [{ title: "Junior Cloud Engineer (GCP)", company: "Cloudify PH", location: "Pasig, PH" }], "AWS Architect": [{ title: "Cloud Engineer (AWS)", company: "Ayala Digital", location: "Makati, PH" }], "Azure Admin": [{ title: "Azure Cloud Administrator", company: "Microsoft PH", location: "Makati, PH" }], "GCP Guardian": [{ title: "Cloud Security Engineer (GCP)", company: "Fintech Innovations", location: "BGC, PH" }], "AWS Guardian": [{ title: "AWS Security Engineer", company: "E-commerce Giant PH", location: "Pasig, PH" }], "Azure Guardian": [{ title: "Azure Security Lead", company: "Major Conglomerate", location: "Makati, PH" }] };
            const AVATARS = ['user', 'user-check', 'user-plus', 'user-minus', 'user-x', 'users'];

            // --- Firebase Initialization ---
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            let userId = null;
            let userDocRef = null;
            let userData = {};
            let currentXP = 0;
            let currentRank = "IT Novice";

            // --- DOM Elements ---
            const radialProgressBar = document.getElementById('radialProgressBar');
            const radialProgressText = document.getElementById('radialProgressText');
            const xpCounter = document.getElementById('xpCounter');
            const rankDisplay = document.getElementById('rankDisplay');
            const modal = document.getElementById('stageModal');
            const profileModal = document.getElementById('profileModal');
            const studyStashList = document.getElementById('studyStashList');
            const displayNameInput = document.getElementById('displayNameInput');
            const avatarGrid = document.getElementById('avatarGrid');
            const profileAvatar = document.getElementById('profileAvatar');
            const profileDisplayName = document.getElementById('profileDisplayName');
            const jobListings = document.getElementById('jobListings');
            const themeToggle = document.getElementById('theme-toggle');
            const spotlight = document.querySelector('.spotlight');

            // --- Functions ---
            function animateValue(obj, start, end, duration) {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    obj.innerHTML = `${Math.floor(progress * (end - start) + start)} XP`;
                    if (progress < 1) { window.requestAnimationFrame(step); }
                };
                window.requestAnimationFrame(step);
            }

            function updateUI() {
                if (!userData || !radialProgressBar) return;
                const selectedPlatform = userData.platform || 'gcp';
                let totalXP = 0;
                let completedStages = 0;
                let highestRank = "IT Novice";
                const totalQuestStages = Object.keys(STAGES_CONFIG).length + Object.keys(PLATFORM_PATHS[selectedPlatform]).length;

                profileDisplayName.textContent = userData.displayName || 'Anonymous Quester';
                profileAvatar.innerHTML = `<i data-feather="${userData.avatar || 'user'}" class="w-20 h-20 text-teal-500"></i>`;
                
                document.querySelectorAll('.platform-btn').forEach(btn => {
                    const isSelected = btn.dataset.platform === selectedPlatform;
                    btn.classList.toggle('bg-teal-600', isSelected);
                    btn.classList.toggle('text-white', isSelected);
                    btn.classList.toggle('bg-gray-200', !isSelected && !document.documentElement.classList.contains('dark'));
                    btn.classList.toggle('dark:bg-gray-700', !isSelected);
                    btn.classList.toggle('text-gray-800', !isSelected && !document.documentElement.classList.contains('dark'));
                    btn.classList.toggle('dark:text-gray-400', !isSelected);
                });

                ['stage3', 'stage4'].forEach(stageId => {
                    const config = PLATFORM_PATHS[selectedPlatform][stageId];
                    const card = document.getElementById(`${stageId}-card`);
                    card.querySelector('.stage-title').textContent = config.title;
                    card.querySelector('.stage-icon').innerHTML = `<i data-feather="${selectedPlatform === 'aws' ? 'box' : selectedPlatform === 'azure' ? 'layers' : 'cloud'}" class="w-5 h-5 text-teal-500"></i>`;
                });
                
                Object.keys(STAGES_CONFIG).forEach(stageId => { if (userData.progress?.[stageId]) { totalXP += STAGES_CONFIG[stageId].xp; highestRank = STAGES_CONFIG[stageId].rank; completedStages++; } });
                Object.keys(PLATFORM_PATHS[selectedPlatform]).forEach(stageId => { if (userData.progress?.[stageId]) { totalXP += PLATFORM_PATHS[selectedPlatform][stageId].xp; highestRank = PLATFORM_PATHS[selectedPlatform][stageId].rank; completedStages++; } });
                Object.keys(ADVANCED_CERTS).forEach(certId => { if (userData.progress?.[certId]) { totalXP += ADVANCED_CERTS[certId].xp; } });

                if (highestRank !== currentRank && currentRank !== "IT Novice") { showRankUpNotification(highestRank); }
                currentRank = highestRank;

                const percentage = totalQuestStages > 0 ? Math.round((completedStages / totalQuestStages) * 100) : 0;
                const circumference = 2 * Math.PI * 54;
                const offset = circumference - (percentage / 100) * circumference;
                radialProgressBar.style.strokeDashoffset = offset;
                radialProgressText.textContent = `${percentage}%`;
                
                if (totalXP !== currentXP) { animateValue(xpCounter, currentXP, totalXP, 1000); currentXP = totalXP; } else { xpCounter.textContent = `${totalXP} XP`; }
                rankDisplay.textContent = highestRank;

                document.querySelectorAll('.progress-item').forEach(item => {
                    const id = item.dataset.stage || item.dataset.cert;
                    const isComplete = userData.progress?.[id] || false;
                    const checkIcon = item.querySelector('.check-icon');
                    item.classList.toggle('completed', isComplete);
                    if (checkIcon) checkIcon.classList.toggle('opacity-0', !isComplete);
                });

                renderStudyStash();
                renderJobBoard(highestRank);
                feather.replace();
            }
            
            function renderJobBoard(rank) {
                jobListings.innerHTML = '';
                const eligibleJobs = JOB_DATA[rank] || [];
                if (eligibleJobs.length === 0) {
                    jobListings.innerHTML = `<div class="text-center p-8 card rounded-lg"><p>No new roles unlocked yet. Complete the next stage to see new opportunities!</p></div>`;
                    return;
                }
                eligibleJobs.forEach(job => {
                    const jobEl = document.createElement('div');
                    jobEl.className = 'card p-4 rounded-lg flex justify-between items-center';
                    jobEl.innerHTML = `<div><h4 class="font-bold" style="color: var(--header-text);">${job.title}</h4><p class="text-sm">${job.company} - ${job.location}</p></div><a href="#" class="text-xs bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-3 rounded-md transition">Apply</a>`;
                    jobListings.appendChild(jobEl);
                });
            }

            function showRankUpNotification(newRank) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-5 right-5 bg-yellow-400 text-gray-900 p-4 rounded-lg shadow-lg z-50 animate-pulse';
                notification.innerHTML = `<strong class="font-bold">Rank Up!</strong> You are now a <span class="font-bold">${newRank}</span>!`;
                document.body.appendChild(notification);
                setTimeout(() => { notification.remove(); }, 5000);
            }

            function renderStudyStash() {
                studyStashList.innerHTML = '';
                if (userData.studyMaterials && userData.studyMaterials.length > 0) {
                    userData.studyMaterials.forEach(material => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between bg-gray-200 dark:bg-gray-900/50 p-3 rounded-lg';
                        li.innerHTML = `<a href="${material.url}" target="_blank" class="flex items-center space-x-3 hover:text-teal-500 truncate"><i data-feather="file-text" class="w-5 h-5 flex-shrink-0"></i><span class="truncate text-sm">${material.name}</span></a><button class="delete-material-btn p-1 text-gray-500 hover:text-red-500"><i data-feather="trash-2" class="w-4 h-4"></i></button>`;
                        li.querySelector('.delete-material-btn').addEventListener('click', () => deleteStudyMaterial(material));
                        studyStashList.appendChild(li);
                    });
                } else {
                    studyStashList.innerHTML = `<p class="text-center text-sm py-4">Your stash is empty. Upload some notes to get started!</p>`;
                }
                feather.replace();
            }

            async function deleteStudyMaterial(material) {
                if (!confirm(`Are you sure you want to delete "${material.name}"?`)) return;
                try {
                    const storageRef = ref(storage, `artifacts/${appId}/users/${userId}/study_materials/${material.name}`);
                    await deleteObject(storageRef);
                    await updateDoc(userDocRef, { studyMaterials: arrayRemove(material) });
                } catch (error) { console.error("Error deleting material: ", error); alert("Could not delete the file."); }
            }

            function openModal(stageId) {
                const selectedPlatform = userData.platform || 'gcp';
                const config = STAGES_CONFIG[stageId] || PLATFORM_PATHS[selectedPlatform][stageId];
                if (!config) return;

                modal.dataset.currentStage = stageId;
                document.getElementById('modalTitle').textContent = config.title;
                document.getElementById('modalDetails').textContent = config.details || "Details for this stage are coming soon.";
                document.getElementById('modalProject').textContent = config.project || "No project defined for this stage.";
                document.getElementById('modalPHContext').textContent = config.ph_context || "Local context for this stage is coming soon.";
                
                const resourcesList = document.getElementById('modalResources');
                resourcesList.innerHTML = '';
                if(config.resources) config.resources.forEach(res => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${res.url}" target="_blank" class="flex items-center space-x-2 text-teal-500 hover:underline"><i data-feather="link" class="w-4 h-4"></i><span>${res.name}</span></a>`;
                    resourcesList.appendChild(li);
                });
                feather.replace();

                ['cert', 'proj'].forEach(type => {
                    const link = document.getElementById(`${type}_link`);
                    const buttonText = document.getElementById(`${type}_upload_button`).querySelector('.upload-text');
                    link.classList.add('hidden');
                    buttonText.textContent = 'Upload File';
                    const data = userData.uploads?.[`${stageId}_${type}`];
                    if (data) { link.href = data.url; link.textContent = data.name; link.classList.remove('hidden'); buttonText.textContent = 'Replace'; }
                });

                const isComplete = userData.progress?.[stageId] || false;
                const completeButton = document.getElementById('modalCompleteButton');
                completeButton.textContent = isComplete ? 'Mark as Incomplete' : 'Mark as Complete';
                completeButton.classList.toggle('bg-red-600', isComplete);
                completeButton.classList.toggle('hover:bg-red-500', isComplete);
                completeButton.classList.toggle('bg-teal-600', !isComplete);
                completeButton.classList.toggle('hover:bg-teal-500', !isComplete);

                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
                switchTab('details');
            }

            function closeModal() {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
            
            function switchTab(tabName) {
                ['details', 'uploads', 'resources'].forEach(name => {
                    const tab = document.getElementById(`tab_${name}`);
                    tab.classList.toggle('text-teal-500', name === tabName);
                    tab.classList.toggle('border-teal-500', name === tabName);
                    tab.classList.toggle('text-gray-500', name !== tabName);
                    tab.classList.toggle('dark:text-gray-400', name !== tabName);
                    tab.classList.toggle('border-transparent', name !== tabName);
                    document.getElementById(`content_${name}`).classList.toggle('hidden', name !== tabName);
                });
            }

            async function saveState(newState) {
                if (!userDocRef) return;
                try { await setDoc(userDocRef, newState, { merge: true }); } 
                catch (error) { console.error("Error saving state: ", error); }
            }

            async function handleFileUpload(event, uploadCategory) {
                const input = event.target;
                const file = input.files[0];
                if (!file || !userId) return;
                
                const isStudyMaterial = uploadCategory === 'studyMaterial';
                const button = isStudyMaterial ? document.getElementById('uploadStudyMaterialBtn') : document.getElementById(`${uploadCategory}_upload_button`);
                const textSpan = button.querySelector('span');

                const originalText = textSpan.textContent;
                textSpan.textContent = 'Uploading...';
                button.disabled = true;

                const storagePath = isStudyMaterial 
                    ? `artifacts/${appId}/users/${userId}/study_materials/${file.name}`
                    : `artifacts/${appId}/users/${userId}/${modal.dataset.currentStage}/${file.name}`;

                try {
                    const storageRef = ref(storage, storagePath);
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    
                    if (isStudyMaterial) {
                        await updateDoc(userDocRef, { studyMaterials: arrayUnion({ name: file.name, url: downloadURL }) });
                    } else {
                        const stageId = modal.dataset.currentStage;
                        await saveState({ uploads: { [`${stageId}_${uploadCategory}`]: { name: file.name, url: downloadURL } } });
                    }
                } catch (error) {
                    console.error("Upload failed:", error);
                    alert("Upload failed.");
                } finally {
                    textSpan.textContent = isStudyMaterial ? 'Add' : 'Replace';
                    button.disabled = false;
                    input.value = '';
                }
            }

            function handleThemeToggle() {
                const isDark = themeToggle.checked;
                document.documentElement.classList.toggle('dark', isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                const dot = document.getElementById('theme-dot');
                if (dot) {
                    dot.innerHTML = isDark ? '<i data-feather="moon" class="text-white"></i>' : '<i data-feather="sun" class="text-yellow-500"></i>';
                    dot.style.transform = isDark ? 'translateX(1.5rem)' : 'translateX(0)';
                    feather.replace();
                }
                updateUI();
            }

            // --- Event Listeners ---
            document.querySelectorAll('.stage-card').forEach(card => card.addEventListener('click', () => openModal(card.dataset.stage)));
            document.querySelectorAll('.platform-btn').forEach(btn => btn.addEventListener('click', () => saveState({ platform: btn.dataset.platform })));
            document.querySelectorAll('.advanced-cert-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    const certId = btn.dataset.cert;
                    saveState({ progress: { [certId]: !(userData.progress?.[certId] || false) } });
                });
            });

            document.getElementById('closeModalButton').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.getElementById('modalCompleteButton').addEventListener('click', () => {
                const stageId = modal.dataset.currentStage;
                saveState({ progress: { [stageId]: !(userData.progress?.[stageId] || false) } });
                closeModal();
            });
            ['cert', 'proj'].forEach(type => {
                document.getElementById(`${type}_upload_button`).addEventListener('click', () => document.getElementById(`${type}_input`).click());
                document.getElementById(`${type}_input`).addEventListener('change', (e) => handleFileUpload(e, type));
            });
            ['details', 'uploads', 'resources'].forEach(name => document.getElementById(`tab_${name}`).addEventListener('click', () => switchTab(name)));
            document.getElementById('uploadStudyMaterialBtn').addEventListener('click', () => document.getElementById('studyMaterialInput').click());
            document.getElementById('studyMaterialInput').addEventListener('change', (e) => handleFileUpload(e, 'studyMaterial'));

            document.getElementById('editProfileBtn').addEventListener('click', () => {
                displayNameInput.value = userData.displayName || '';
                avatarGrid.innerHTML = '';
                AVATARS.forEach(avatar => {
                    const btn = document.createElement('button');
                    btn.className = 'p-2 rounded-full hover:bg-gray-600';
                    btn.innerHTML = `<i data-feather="${avatar}" class="w-10 h-10 text-gray-300"></i>`;
                    btn.onclick = () => {
                        saveState({ avatar });
                        profileModal.classList.add('hidden');
                    };
                    avatarGrid.appendChild(btn);
                });
                feather.replace();
                profileModal.classList.remove('hidden');
            });
            document.getElementById('closeProfileModalBtn').addEventListener('click', () => profileModal.classList.add('hidden'));
            document.getElementById('saveDisplayNameBtn').addEventListener('click', () => {
                saveState({ displayName: displayNameInput.value });
                profileModal.classList.add('hidden');
            });

            themeToggle.addEventListener('change', handleThemeToggle);
            document.addEventListener('mousemove', (e) => {
                spotlight.style.left = `${e.clientX}px`;
                spotlight.style.top = `${e.clientY}px`;
            });

            // --- Auth & Data Loading ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/progress/tracker`);
                    onSnapshot(userDocRef, (docSnap) => {
                        userData = docSnap.exists() ? docSnap.data() : { platform: 'gcp', progress: {}, uploads: {}, studyMaterials: [] };
                        updateUI();
                    });
                }
            });

            async function signIn() {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
                    else { await signInAnonymously(auth); }
                } catch (error) { console.error("Authentication failed: ", error); }
            }

            // --- Initial Load ---
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                themeToggle.checked = false;
            } else {
                themeToggle.checked = true;
            }
            handleThemeToggle();

            signIn();
            feather.replace();
        });
    </script>
</body>
</html>
